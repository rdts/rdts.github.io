<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - glTF loader</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>

	<body>
		<div id="info">
			Perseverance model via <a href="https://mars.nasa.gov/resources/25042/mars-perseverance-rover-3d-model/" target="_blank" rel="noopener">NASA/JPL</a><br />
		</div>

		<script type="module">
    
      let arm_joint = [];
      arm_joint[1] = {model_obj_name: "arm003",     axis: "y", dir:  1, offset: 0};
      arm_joint[2] = {model_obj_name: "arm002",     axis: "z", dir: -1, offset: 0};
      arm_joint[3] = {model_obj_name: "arm",        axis: "z", dir: -1, offset: -1*Math.PI/2};
      arm_joint[4] = {model_obj_name: "arm004",     axis: "z", dir: -1, offset: Math.PI/2};
      arm_joint[5] = {model_obj_name: "turret_obj", axis: "y", dir: -1, offset: 0};
    
			import * as THREE from './js/three.module.js';

			import { OrbitControls } from './js/OrbitControls.js';
			import { GLTFLoader } from './js/GLTFLoader.js';

			let camera, scene, renderer, rover;
      let modulevars = {camera, scene, renderer, rover}
      window.modulevars = modulevars;

      window.render = render;

			init();
			render();

			function init() {

				const container = document.createElement( 'div' );
				document.body.appendChild( container );

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera.position.set( 1.8, 2, 3 );

				scene = new THREE.Scene();
        window.scene = scene;
        scene.background = new THREE.Color( 0xaaaaaa );

        const ambientlight = new THREE.AmbientLight( 0x302010 ); // soft white light
        scene.add( ambientlight );
        const directionalLight = new THREE.DirectionalLight( 0xfff6ee, 0.8 );
        scene.add( directionalLight );
        //const pointlight = new THREE.PointLight( 0xffeecc, 1, 200 );
        //pointlight.position.set( 10, 15, 5 );
        //scene.add( pointlight );
        directionalLight.castShadow = true;
        directionalLight.shadow.camera.near = 0.01;
        directionalLight.shadow.camera.far = 100;
        directionalLight.position.set(10,10,4);
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;

        
        //pointlight.shadow.camera.near = 0.1;
        //pointlight.shadow.camera.far = 40;

const geometry = new THREE.PlaneGeometry( 20, 20, 32 );
const groundMaterial = new THREE.MeshPhongMaterial({ color: 0xaa9977  });
const plane = new THREE.Mesh( geometry, groundMaterial );
plane.rotation.x = -1*Math.PI/2;
plane.receiveShadow = true;
scene.add( plane );

        //const loader = new GLTFLoader();
        //loader.crossOrigin='';
        //loader.mimeType = 'application/octet-stream';
        //loader.setRequestHeader  = {"X-Requested-With": "XMLHttpRequest"};
        //let model_url = "https://cors-anywhere.herokuapp.com/https://mars.nasa.gov/system/resources/gltf_files/25042_Perseverance.glb";

        const loader = new GLTFLoader().setPath( 'model/' );        
        loader.load( 'Perseverance.glb', function ( gltf ) {
        //loader.load( model_url, function ( gltf ) {
          rover = gltf;
          window.rover = rover;
          rover.scene.traverse( function ( child ) {
            child.castShadow = true;
            child.receiveShadow = true;
          
          
            // Check if this is an arm joint object:
            for(var i=1; i<=5; i++){
              if(child.name == arm_joint[i].model_obj_name){
                console.log("found " + child.name);
                arm_joint[i].obj = child;
                arm_joint[i].theta0 = child.rotation[arm_joint[i].axis].valueOf();
              }
            }

            if ( child.isMesh ) {
              child.material.side = THREE.FrontSide;
              var prevMaterial = child.material;
              child.material = new THREE.MeshPhongMaterial();
              THREE.MeshBasicMaterial.prototype.copy.call( child.material, prevMaterial );
              //child.material = new THREE.MeshPhongMaterial({ flatShading: true });
            } else {
              console.log(child);
            }
            
          } );
          console.log(rover);
          window.arm_joint = arm_joint;
          scene.add( rover.scene );
          render();
        } );


				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.shadowMap.enabled = true; 
    renderer.shadowMapSoft = true; 
        //renderer.gammaOutput = true;
        //renderer.gammaFactor = 2.2;
        window.renderer = renderer;
				container.appendChild( renderer.domElement );


				const controls = new OrbitControls( camera, renderer.domElement );
				controls.addEventListener( 'change', render ); // use if there is no animation loop
				controls.minDistance = 0.1;
				controls.maxDistance = 100;
				controls.target.set( 0, 1, 0 );
				controls.update();

				window.addEventListener( 'resize', onWindowResize );
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
				render();
			}

			//

			function render() {
				renderer.render( scene, camera );
			}


      function setArmPose(joint_angles){
        for(var n=1; n<=5; n++){
          arm_joint[n].obj.rotation[arm_joint[n].axis] = arm_joint[n].dir*joint_angles[n-1] + arm_joint[n].theta0 + arm_joint[n].offset;
        }
      }
      window.setArmPose = setArmPose;


		</script>

	</body>
</html>
