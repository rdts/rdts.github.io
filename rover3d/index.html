<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - glTF loader</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>

	<body>
		<div id="info">
			Perseverance model via <a href="https://mars.nasa.gov/resources/25042/mars-perseverance-rover-3d-model/" target="_blank" rel="noopener">NASA/JPL</a><br />
		</div>

    <script src="js/dat.gui.min.js"></script>


		<script type="module">
      import * as THREE from './js/three.module.js';
			import { OrbitControls } from './js/OrbitControls.js';
			import { GLTFLoader } from './js/GLTFLoader.js';
    
      let arm_joint = [];
      arm_joint[1] = {model_obj_name: "arm003",     axis: "y", dir:  1, offset: 0};
      arm_joint[2] = {model_obj_name: "arm002",     axis: "z", dir: -1, offset: 0};
      arm_joint[3] = {model_obj_name: "arm",        axis: "z", dir: -1, offset: -1*Math.PI/2};
      arm_joint[4] = {model_obj_name: "arm004",     axis: "z", dir: -1, offset: Math.PI/2};
      arm_joint[5] = {model_obj_name: "turret_obj", axis: "y", dir: -1, offset: Math.PI};
    
      let sun = {az: -60, el: 60, dist: 20, x:0, y:0, z:0, obj:null};
    
			let camera, scene, renderer, rover;
      let modulevars = {camera, scene, renderer, rover}
      window.modulevars = modulevars;

      window.render = render;

      let deg2rad = Math.PI/180;

      let options = {
        showSun:  false,
        showFloor:  false,
        sunAz:  -60,
        sunEl:  60,
      };


			init();
			render();

			function init() {

				const container = document.createElement( 'div' );
				document.body.appendChild( container );

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.shadowMap.enabled = true; 
        renderer.shadowMapSoft = true; 
        //renderer.gammaOutput = true;
        //renderer.gammaFactor = 2.2;
        window.renderer = renderer;
				container.appendChild( renderer.domElement );

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera.position.set( 1.8, 2, 3 );

				scene = new THREE.Scene();
        window.scene = scene;
        scene.background = new THREE.Color( 0xaaaaaa );

        const ambientlight = new THREE.AmbientLight( 0x353025 ); // soft white light
        scene.add( ambientlight );
        const directionalLight = new THREE.DirectionalLight( 0xfff6ee, 0.8 );
        //const pointlight = new THREE.PointLight( 0xffeecc, 1, 200 );
        //pointlight.position.set( 10, 15, 5 );
        //scene.add( pointlight );
        directionalLight.castShadow = true;
        directionalLight.shadow.camera.near = 0.01;
        directionalLight.shadow.camera.far = 100;
        directionalLight.position.set(10,10,4);
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        sun.obj = directionalLight;
        placeSun();
        scene.add( directionalLight );
        
        const geometry = new THREE.PlaneGeometry( 20, 20, 32 );
        const groundMaterial = new THREE.MeshPhongMaterial({ color: 0xaa8877  });
        const plane = new THREE.Mesh( geometry, groundMaterial );
        plane.rotation.x = -1*Math.PI/2;
        plane.receiveShadow = true;
        scene.add( plane );

        //const loader = new GLTFLoader();
        //loader.crossOrigin='';
        //loader.mimeType = 'application/octet-stream';
        //loader.setRequestHeader  = {"X-Requested-With": "XMLHttpRequest"};
        //let model_url = "https://cors-anywhere.herokuapp.com/https://mars.nasa.gov/system/resources/gltf_files/25042_Perseverance.glb";

        var armUnstowFcnWrapper = { add:function(){ armUnstow() }};
        var armStowFcnWrapper = { add:function(){ armStow() }};


        var gui = new dat.GUI();
        gui.add(sun, 'az', -180, 180).listen().name("Sun azimuth").onChange(function(val){placeSun()});
        gui.add(sun, 'el', 0, 90).listen().name("Sun elevation").onChange(function(val){placeSun()});
        gui.add(options, 'showSun').listen().name("Show sun").onChange(function(val){ noOp() });
        gui.add(options, 'showFloor').listen().name("Show floor").onChange(function(val){ noOp() });
        gui.add(armStowFcnWrapper,'add').name("Stow Arm");
        gui.add(armUnstowFcnWrapper,'add').name("Unstow Arm");


        const loader = new GLTFLoader().setPath( 'model/' );        
        loader.load( 'Perseverance.glb', function ( gltf ) {
        //loader.load( model_url, function ( gltf ) {
          rover = gltf;
          window.rover = rover;
          rover.scene.traverse( function ( child ) {
            child.castShadow = true;
            child.receiveShadow = true;
          
          
            // Check if this is an arm joint object:
            for(var i=1; i<=5; i++){
              if(child.name == arm_joint[i].model_obj_name){
                console.log("found " + child.name);
                arm_joint[i].obj = child;
                arm_joint[i].theta0 = child.rotation[arm_joint[i].axis].valueOf();
              }
            }

            if ( child.isMesh ) {
              child.material.side = THREE.FrontSide;
              var prevMaterial = child.material;
              child.material = new THREE.MeshPhongMaterial();
              THREE.MeshBasicMaterial.prototype.copy.call( child.material, prevMaterial );
              //child.material = new THREE.MeshPhongMaterial({ flatShading: true });
            } else {
              console.log(child);
            }
            
          } );
          console.log(rover);
          window.arm_joint = arm_joint;
          scene.add( rover.scene );
          render();
        } );


				const controls = new OrbitControls( camera, renderer.domElement );
				controls.addEventListener( 'change', render ); // use if there is no animation loop
				controls.minDistance = 0.1;
				controls.maxDistance = 100;
				controls.target.set( 0, 1, 0 );
				controls.update();

				window.addEventListener( 'resize', onWindowResize );
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
				render();
			}

			//

			function render() {
				renderer.render( scene, camera );
			}


      function setArmPose(joint_angles){
        for(var n=1; n<=5; n++){
          armSetJoint(n, joint_angles[n-1]);
        }
      }
      window.setArmPose = setArmPose;

      function armSetJoint(jointNum, angle){
        arm_joint[jointNum].obj.rotation[arm_joint[jointNum].axis] = arm_joint[jointNum].dir*angle + arm_joint[jointNum].theta0 + arm_joint[jointNum].offset;
      }

      function placeSun(){
        sun.x = sun.dist * Math.cos(sun.el * deg2rad) * Math.sin(-1*sun.az * deg2rad) ;
        sun.z = sun.dist * Math.cos(sun.el * deg2rad) * Math.cos(sun.az * deg2rad);
        sun.y = sun.dist * Math.sin(sun.el * deg2rad);
        sun.obj.position.set(sun.x, sun.y, sun.z);
        render();
      }


      function noOp(){
        return;
      }

      function armUnstow(){
        console.log("UNSTOW");
        setArmPose([0, -1.5708, 1.5708, 0, 3.14159]);
        render();
      }
      
      function armStow(){
        console.log("STOW");
        setArmPose([1.5721, -0.27778, -2.8163, 3.12111, 1.5708]);
        render();
      }


		</script>

	</body>
</html>
