<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Rover Pics</title>

<style>

body {
  background-color: #555;
  color: #eeeeee
}

button {
  width: 18ch;
  font-weight: bold;
}

.checkbox_div {
  white-space: nowrap;
  text-align: left
}

table, td, th {
  color: #0b0b0b;
  border: 1px solid #999;
}

td {
  background-color: #eae6e0
}

th {
  background-color: #dcb
}

table {
  width: 100%;
  border-collapse: collapse;
}

#loading {
  float: none;
  display: none;
  width: 30px;
  height: 30px;
  margin-left: 20px;
  border: 8px solid rgba(255,255,255,.2);
  border-radius: 50%;
  border-top-color: #ccbbaa;
  animation: spin 1s ease-in-out infinite;
  -webkit-animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}
@-webkit-keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}


.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  color: #321;
}

.modal_close_button {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

</style>
</head>


<body>

<!-- INFO -->
<div id="info_modal" class="modal">
  <div class="modal-content">
    <span class="modal_close_button">&times;</span>
    <h2>Rover Pics</h2>
    <p>
      R. Kinnett, 2021.
    </p>
    <p>   
      Also see NASA's raw images pages for <a href="https://mars.nasa.gov/msl/multimedia/raw-images/">MSL (Curiosity)</a> and <a href="https://mars.nasa.gov/mars2020/multimedia/raw-images/">Mars 2020 (Perseverance)</a> <br/><br/>
    
      This interface retrieves image information lists via JPL's RSS API and builds a table showing thumbnails and basic metadata for each image, along with links to the maximum available resolution images. <br/><br/>
    
      Start by querying image lists using the mission "Latest" or "Sol" buttons in the upper left.
      <ul>
        <li>The MSL and Mars 2020 "Latest" buttons retrieve information about and links to the latest 25 images from each mission.</li>
        <li>The MSL and Mars 2020 "Sol" buttons prompt the user for a sol number (single sol, for now..) and retrieves information about all available images for a specified sol.</li>
      </ul> 
          
      After retrieving image information via the mission "Latest" or "Sol" buttons, the user may:
      <ol>
        <li>
          Export a JSON file containing all info retrieved from JPL,
        </li>
        <li>
          Use checkboxes under the Camera and Type headings to narrow the table to specific images of interest, then use a browser extension (for Chrome, I recommend <a href="https://chrome.google.com/webstore/detail/simple-mass-downloader/abdkkegmcbiomijcbdaodaflgehfffed?hl=en-US">Simple Mass Downloader</a>) to download all full-frame (or largest available) images remaining in the table via the provided links.
        </li>
        <li>
          Down-select further via checkboxes in the Select column and click "Export selected image URLs" to save a text file containing URLs to the full-frame (or max available) images which can be used in conjunction with command-line tools such as wget and curl.
        </li>
      </ol>
      
    
  </div>
</div>



<!-- TOP LEFT AREA -->
<div style="overflow: hidden; display: inline-block">
  <div style="display: block">
    <div style="display: inline-block">
      <div style="display: block; padding: 5px">
        <button onclick="getLatest('msl')" >MSL latest</button> 
        <button onclick="getSol('msl')" >MSL sol</button>
      </div>
      <div style="display: block; padding: 5px">
        <button onclick="getLatest('mars2020')" >Mars 2020 Latest</button>
        <button onclick="getSol('mars2020')" >Mars 2020 Sol</button>
      </div>
    </div>
    
    <div style="display: inline-block">
      <div id="loading" style="display: none"></div>
    </div>
  </div>
  
  <div style="display:inline-block" id="summary"> 
    <h3>Empty</h3> 
  </div>
</div>

<!-- TOP RIGHT AREA -->
<div style="float:right">
  <div style="display: block; padding: 5px">
    <button id="modal_open_button">INFO</button>
  </div>
  <div style="display: block; padding: 5px">
    <button onclick="exportJson()">Export JSON</button> 
  </div>
  <div style="display: block; padding: 5px">
    <button onclick="exportImageURLs()">Export selected image URLs</button> 
  </div>
</div>


<table id="images_table">
<tr>
  <th> <h3>Select</h3> 
    <div>
      <a onclick="selectAll()">[all]</a>&nbsp;
      <a onclick="selectNone()">[none]</a>
    </div>
  </th>
  <th> <h3>Thumbnail</h3> </th>
  <th> <h3 onclick="sortTable(1)">Camera</h3> <form id="cam_filter"></form> </th>
  <th> <h3 onclick="sortTable(2)">Type</h3>  <form id="type_filter"></form> </th>
  <th> <h3 onclick="sortTable(3)">Image ID</h3> </th>
  <th> <h3 onclick="sortTable(4)">Date Taken</h3> </th>
</tr>
</table>


<script>

var got_images = false;
var table = document.getElementById("images_table");
var spinner = document.getElementById("loading");
var cameras = [];
var camera_type_img_counts = [];
var image_types = [];
var image_type_img_counts = [];
var num_rows = 0;
var num_images = 0;
var image_list_json;
var checked_checkbox_names = [];





// Get the modal
var modal = document.getElementById("info_modal");

// Get the button that opens the modal
var btn = document.getElementById("modal_open_button");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("modal_close_button")[0];

// When the user clicks the button, open the modal 
btn.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}


function selectAll(){
  console.log("selecting all");
  for(var r=1; r<=num_rows; r++){
    table.rows[r].cells[0].querySelector('input[type="checkbox"]').checked = true;
  }
}

function selectNone(){
  console.log("deselecting all");
  for(var r=1; r<=num_rows; r++){
    table.rows[r].cells[0].querySelector('input[type="checkbox"]').checked = false;
  }
}



function getLatest(mission){
  fetchRss('https://mars.nasa.gov/rss/api/?feed=raw_images&feedtype=json&category=' + mission);
}

function getSol(mission){
  var sol = parseInt(window.prompt("Specify sol", 0), 0);
  if ( /^[0-9.,]+$/.test(sol)) {
    fetchRss('https://mars.nasa.gov/rss/api/?feed=raw_images&feedtype=json&category=' + mission + '&sol=' + sol);
  } else {
    console.log("not a number, or canceled.");
  }
}

  
function fetchRss(rss_url){
  console.log("fetching rss feed:  " + rss_url);
  setBusyIndicator(true);
  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4) {
      clearTable();
      if (this.status == 200) {
        console.log(this.responseText);
        image_list_json = JSON.parse(this.responseText);
        console.log(image_list_json);
        got_images = true;
        tabulateImages();
        buildTable();
      } else {
        console.log("unexpected response:");
        console.log(this.responseText);
        alert("Error fetching requested feed. The server may be overloaded, or it's possible no images have been posted from the requested sol.");
      }
      setBusyIndicator(false);
    }
  };
  setBusyIndicator(true);
  xhttp.open("GET", rss_url, true);
  setTimeout(function(){ xhttp.send(); }, 100);
}


function clearTable(){
  for (var r=table.rows.length-1; r>0; r--) {
    table.deleteRow(r);
  }
  num_rows = 0;
}


function tabulateImages(){
  console.log("tabulating images");
  cameras = [];
  image_types = [];
  
  camera_type_img_counts = [];
  image_type_img_counts = [];
  
  num_images = image_list_json.images.length;
  start_sol = image_list_json.images[0].sol;
  end_sol = image_list_json.images[num_images-1].sol;

  document.getElementById("summary").innerHTML = '<h3>' + image_list_json.images.length + ' images from ' + image_list_json.mission.toUpperCase() + ' sol ' + start_sol + ((end_sol>start_sol)?(' to sol ' + end_sol):'') + '</h3>';

  for(n=0; n<num_images; n++){
    var this_img = image_list_json.images[n];
    var type     = this_img.sample_type;
    var camera   = this_img.camera.instrument;
    // console.log('image ' + n + ', ' + camera + ', ' + type);

    if(!cameras.includes(camera)) {
      cameras.push(camera);
      camera_type_img_counts[camera]=0;
    }
    if(!image_types.includes(type)) {
      image_types.push(type);
      image_type_img_counts[type]=0;
    }
    camera_type_img_counts[camera]++;
    image_type_img_counts[type]++;
  }
  
  console.log(camera_type_img_counts);
  console.log(image_type_img_counts);
  
  // Clear and repopulate filter checkboxes:
  document.getElementById("cam_filter").innerHTML = "";
  document.getElementById("type_filter").innerHTML = "";
  cameras.forEach(function(cam_type){makeCheckbox("cam_filter",cam_type)});
  image_types.forEach(function(img_type){makeCheckbox("type_filter",img_type)});
  setBusyIndicator(false);
}



function buildTable(){
  console.log("building table");
  clearTable();

  // rebuild checked-checkboxes list:
  checked_checkbox_names = [];
  var checked_checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
  console.log(checked_checkboxes);
  for (var i=0; i<checked_checkboxes.length; i++) {
    checked_checkbox_names.push(checked_checkboxes[i].name);
  }
  console.log(checked_checkbox_names);

  // build table:
  for(n=0; n<num_images; n++){
    var this_img = image_list_json.images[n];
    img_type     = this_img.sample_type;
    cam_type     = this_img.camera.instrument;
  
    if(checked_checkbox_names.includes(cam_type) && checked_checkbox_names.includes(img_type)){
      //console.log("showing image " + n + " " + cam_type + " " + img_type);    

      thumb_url   = this_img.image_files["small"];
      biggest_url = this_img.image_files["full_res"];
      image_id    = this_img.imageid;
      date_lmst   = this_img.date_taken_mars.replace("M"," ");
      date_utc    = this_img.date_taken_utc.replace("T"," ");    
      date_local  = new Date(date_utc + " UTC").toString();  

      num_rows++;
      var row = table.insertRow(num_rows);
      var cell0 = row.insertCell(0);
      var cell1 = row.insertCell(1);
      var cell2 = row.insertCell(2);
      var cell3 = row.insertCell(3);
      var cell4 = row.insertCell(4);
      var cell5 = row.insertCell(5);

      cell0.innerHTML = '<input type="checkbox" id="SEL_' + image_id + '">';
      cell1.innerHTML = '<img src=' + thumb_url + ' />';
      cell2.innerHTML = cam_type;
      cell3.innerHTML = '<a href=' + biggest_url + ' download>' + img_type + '</a>';
      cell4.innerHTML = image_id;
      cell5.innerHTML = date_lmst + ' <br/> ' + date_utc + ' <br/> ' + date_local;

    } else {
      //console.log("skipping image " + n + " " + cam_type + " " + img_type);
    }    
  }
  setBusyIndicator(false);
}



function makeCheckbox(container_name, checkbox_name){
  var count = (container_name=="cam_filter") ? camera_type_img_counts[checkbox_name] : image_type_img_counts[checkbox_name];
  var container = document.getElementById(container_name);
  container.innerHTML += '<div class="checkbox_div"><input type="checkbox" name="' + checkbox_name + '" id="' + checkbox_name + '" onchange="doFilter()" checked><label for="' + checkbox_name + '">' + checkbox_name + '&nbsp;(' + count + ')</label></div>';
}


function doFilter() {
  console.log("filtering");
  setBusyIndicator(true);
  setTimeout(function(){buildTable()}, 200);
}


function sortTable(n){
  setBusyIndicator(true);
  setTimeout(function(){ doSort(n) }, 200);
}


function doSort(n) {
  console.log("starting sort");
  var rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  switching = true;
  // Set the sorting direction to ascending:
  dir = "asc";
  // loop continues until no switching has been done:
  while (switching) {
    switching = false;
    rows = table.rows;
    // Loop through all table rows (except the first, which contains table headers):
    for (i = 1; i < (rows.length - 1); i++) {
      shouldSwitch = false;
      /* Get the two elements you want to compare, one from current row and one from the next: */
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      /* Check if the two rows should switch place, based on the direction, asc or desc: */
      if (dir == "asc") {
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      } else if (dir == "desc") {
        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      }
    }
    if (shouldSwitch) {
      /* If a switch has been marked, make the switch and mark that a switch has been done: */
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      // Each time a switch is done, increase this count by 1:
      switchcount ++;
    } else {
      /* If no switching has been done AND the direction is "asc",
      set the direction to "desc" and run the while loop again. */
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
  console.log("done sorting");
  setBusyIndicator(false);
}


function exportImageURLs(){
  if(!got_images) {
    alert('Use the mission "Latest" or "Sol" buttons to retrieve image information first');
    return;
  }
  var urls_text = '';
  for(var r=1; r<=num_rows; r++){
    var checked = table.rows[r].cells[0].querySelector('input[type="checkbox"]').checked;
    if(checked){
      urls_text += table.rows[r].cells[3].querySelector('a').href + '\n';
    }
  }
  urls_text = urls_text.replace(/\n$/, "");
  console.log(urls_text);
  var blob = new Blob([urls_text], { type: "text/plain;charset=utf-8" });
  const a = document.createElement('a');
  a.href= URL.createObjectURL(blob);
  var fname = document.getElementById("summary").innerText.replace(/.* from /,"").replace(/ /g,"_") + '_image_urls.txt'
  a.download = fname;
  a.click();
	URL.revokeObjectURL(a.href);
}

function exportJson(){
  if(!got_images) {
    alert('Use the mission "Latest" or "Sol" buttons to retrieve image information first');
    return;
  }
  var blob = new Blob([JSON.stringify(image_list_json, null, '\t')], { type: "text/plain;charset=utf-8" });
  const a = document.createElement('a');
  a.href= URL.createObjectURL(blob);
  var fname = document.getElementById("summary").innerText.replace(/.* from /,"").replace(/ /g,"_") + '_image_data.json'
  a.download = fname;
  a.click();
	URL.revokeObjectURL(a.href);
}




function setBusyIndicator(busy) {
  if(busy) {
    console.log("busy");
    spinner.style.display = "inline-block";
  } else {
    console.log("done being busy");
    spinner.style.display = "none";  
  }
}


</script>

</body>
</html>