<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Rover Pics</title>

<style>

body {
  background-color: #555;
  color: #eeeeee
}

button {
  width: 18ch;
  font-weight: bold;
}

.checkbox_div {
  white-space: nowrap;
  text-align: left
}

table, td, th {
  color: #0b0b0b;
  border: 1px solid #999;
}

td {
  background-color: #eae6e0
}

th {
  background-color: #dcb
}

table {
  width: 100%;
  border-collapse: collapse;
}

#loading {
  float: none;
  display: none;
  width: 30px;
  height: 30px;
  margin-left: 20px;
  border: 8px solid rgba(255,255,255,.2);
  border-radius: 50%;
  border-top-color: #ccbbaa;
  animation: spin 1s ease-in-out infinite;
  -webkit-animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}
@-webkit-keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}

</style>
</head>


<body>

<div style="float:right">Recommned <a href="https://chrome.google.com/webstore/detail/simple-mass-downloader/abdkkegmcbiomijcbdaodaflgehfffed?hl=en-US">Simple Mass Downloader</a> for Chrome.</div>

<div style="overflow: hidden; ">
  <div style="display: inline-block">
    <button onclick="getLatest('msl')" >MSL latest</button> 
    <button onclick="getSol('msl')" >MSL sol</button>
    </br>
    </br>
    <button onclick="getLatest('mars2020')" >Mars 2020 Latest</button>
    <button onclick="getSol('mars2020')" >Mars 2020 Sol</button>
  </div>
  <div style="display: inline-block">
    <div id="loading" style="display: none"></div>
  </div>
</div>



<div>
  <div style="display:inline-block" id="summary"> <h3>Empty</h3> </div>
  <div style="float:right"> <button onclick="makeManifestFile()" style="float:right">Export selected image URLs</button> </div>
</div>


<table id="images_table">
<tr>
  <th> <h3>Select</h3> 
    <div>
      <a onclick="selectAll()">[all]</a>&nbsp;
      <a onclick="selectNone()">[none]</a>
    </div>
  </th>
  <th> <h3>Thumbnail</h3> </th>
  <th> <h3 onclick="sortTable(1)">Camera</h3> <form id="cam_filter"></form> </th>
  <th> <h3 onclick="sortTable(2)">Type</h3>  <form id="type_filter"></form> </th>
  <th> <h3 onclick="sortTable(3)">Image ID</h3> </th>
  <th> <h3 onclick="sortTable(4)">Date Taken</h3> </th>
</tr>
</table>


<script>

var table = document.getElementById("images_table");
var spinner = document.getElementById("loading");
var cameras = [];
var camera_type_img_counts = [];
var image_types = [];
var image_type_img_counts = [];
var num_rows = 0;
var num_images = 0;
var image_list_json;
var checked_checkbox_names = [];


function selectAll(){
  console.log("selecting all");
  for(var r=1; r<=num_rows; r++){
    table.rows[r].cells[0].querySelector('input[type="checkbox"]').checked = true;
  }
}

function selectNone(){
  console.log("deselecting all");
  for(var r=1; r<=num_rows; r++){
    table.rows[r].cells[0].querySelector('input[type="checkbox"]').checked = false;
  }
}



function getLatest(mission){
  fetchRss('https://mars.nasa.gov/rss/api/?feed=raw_images&feedtype=json&category=' + mission);
}

function getSol(mission){
  var sol = parseInt(window.prompt("Specify sol", 0), 0);
  if ( /^[0-9.,]+$/.test(sol)) {
    fetchRss('https://mars.nasa.gov/rss/api/?feed=raw_images&feedtype=json&category=' + mission + '&sol=' + sol);
  } else {
    console.log("not a number, or canceled.");
  }
}

  
function fetchRss(rss_url){
  console.log("fetching rss feed:  " + rss_url);
  setBusyIndicator(true);
  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4) {
      clearTable();
      if (this.status == 200) {
        console.log(this.responseText);
        image_list_json = JSON.parse(this.responseText);
        console.log(image_list_json);
        tabulateImages();
        buildTable();
      } else {
        console.log("unexpected response:");
        console.log(this.responseText);
        alert("Error fetching requested feed. The server may be overloaded, or it's possible no images have been posted from the requested sol.");
      }
      setBusyIndicator(false);
    }
  };
  setBusyIndicator(true);
  xhttp.open("GET", rss_url, true);
  setTimeout(function(){ xhttp.send(); }, 100);
}


function clearTable(){
  for (var r=table.rows.length-1; r>0; r--) {
    table.deleteRow(r);
  }
  num_rows = 0;
}


function tabulateImages(){
  console.log("tabulating images");
  cameras = [];
  image_types = [];
  
  camera_type_img_counts = [];
  image_type_img_counts = [];
  
  num_images = image_list_json.images.length;
  start_sol = image_list_json.images[0].sol;
  end_sol = image_list_json.images[num_images-1].sol;

  document.getElementById("summary").innerHTML = '<h3>' + image_list_json.images.length + ' images from ' + image_list_json.mission.toUpperCase() + ' sol ' + start_sol + ((end_sol>start_sol)?(' to sol ' + end_sol):'') + '</h3>';

  for(n=0; n<num_images; n++){
    var this_img = image_list_json.images[n];
    var type     = this_img.sample_type;
    var camera   = this_img.camera.instrument;
    // console.log('image ' + n + ', ' + camera + ', ' + type);

    if(!cameras.includes(camera)) {
      cameras.push(camera);
      camera_type_img_counts[camera]=0;
    }
    if(!image_types.includes(type)) {
      image_types.push(type);
      image_type_img_counts[type]=0;
    }
    camera_type_img_counts[camera]++;
    image_type_img_counts[type]++;
  }
  
  console.log(camera_type_img_counts);
  console.log(image_type_img_counts);
  
  // Clear and repopulate filter checkboxes:
  document.getElementById("cam_filter").innerHTML = "";
  document.getElementById("type_filter").innerHTML = "";
  cameras.forEach(function(cam_type){makeCheckbox("cam_filter",cam_type)});
  image_types.forEach(function(img_type){makeCheckbox("type_filter",img_type)});
  setBusyIndicator(false);
}



function buildTable(){
  console.log("building table");
  clearTable();

  // rebuild checked-checkboxes list:
  checked_checkbox_names = [];
  var checked_checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
  console.log(checked_checkboxes);
  for (var i=0; i<checked_checkboxes.length; i++) {
    checked_checkbox_names.push(checked_checkboxes[i].name);
  }
  console.log(checked_checkbox_names);

  // build table:
  for(n=0; n<num_images; n++){
    var this_img = image_list_json.images[n];
    img_type     = this_img.sample_type;
    cam_type     = this_img.camera.instrument;
  
    if(checked_checkbox_names.includes(cam_type) && checked_checkbox_names.includes(img_type)){
      //console.log("showing image " + n + " " + cam_type + " " + img_type);    

      thumb_url   = this_img.image_files["small"];
      biggest_url = this_img.image_files["full_res"];
      image_id    = this_img.imageid;
      date_lmst   = this_img.date_taken_mars.replace("M"," ");
      date_utc    = this_img.date_taken_utc.replace("T"," ");    
      date_local  = new Date(date_utc + " UTC").toString();  

      num_rows++;
      var row = table.insertRow(num_rows);
      var cell0 = row.insertCell(0);
      var cell1 = row.insertCell(1);
      var cell2 = row.insertCell(2);
      var cell3 = row.insertCell(3);
      var cell4 = row.insertCell(4);
      var cell5 = row.insertCell(5);

      cell0.innerHTML = '<input type="checkbox" id="SEL_' + image_id + '">';
      cell1.innerHTML = '<img src=' + thumb_url + ' />';
      cell2.innerHTML = cam_type;
      cell3.innerHTML = '<a href=' + biggest_url + ' download>' + img_type + '</a>';
      cell4.innerHTML = image_id;
      cell5.innerHTML = date_lmst + ' <br/> ' + date_utc + ' <br/> ' + date_local;

    } else {
      //console.log("skipping image " + n + " " + cam_type + " " + img_type);
    }    
  }
  setBusyIndicator(false);
}



function makeCheckbox(container_name, checkbox_name){
  var count = (container_name=="cam_filter") ? camera_type_img_counts[checkbox_name] : image_type_img_counts[checkbox_name];
  var container = document.getElementById(container_name);
  container.innerHTML += '<div class="checkbox_div"><input type="checkbox" name="' + checkbox_name + '" id="' + checkbox_name + '" onchange="doFilter()" checked><label for="' + checkbox_name + '">' + checkbox_name + '&nbsp;(' + count + ')</label></div>';
}


function doFilter() {
  console.log("filtering");
  setBusyIndicator(true);
  setTimeout(function(){buildTable()}, 200);
}


function sortTable(n){
  setBusyIndicator(true);
  setTimeout(function(){ doSort(n) }, 200);
}


function doSort(n) {
  console.log("starting sort");
  var rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  switching = true;
  // Set the sorting direction to ascending:
  dir = "asc";
  // loop continues until no switching has been done:
  while (switching) {
    switching = false;
    rows = table.rows;
    // Loop through all table rows (except the first, which contains table headers):
    for (i = 1; i < (rows.length - 1); i++) {
      shouldSwitch = false;
      /* Get the two elements you want to compare, one from current row and one from the next: */
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      /* Check if the two rows should switch place, based on the direction, asc or desc: */
      if (dir == "asc") {
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      } else if (dir == "desc") {
        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      }
    }
    if (shouldSwitch) {
      /* If a switch has been marked, make the switch and mark that a switch has been done: */
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      // Each time a switch is done, increase this count by 1:
      switchcount ++;
    } else {
      /* If no switching has been done AND the direction is "asc",
      set the direction to "desc" and run the while loop again. */
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
  console.log("done sorting");
  setBusyIndicator(false);
}


function makeManifestFile(){
  var urls_text = '';
  for(var r=1; r<=num_rows; r++){
    var checked = table.rows[r].cells[0].querySelector('input[type="checkbox"]').checked;
    if(checked){
      urls_text += table.rows[r].cells[3].querySelector('a').href + '\n';
    }
  }
  urls_text = urls_text.replace(/\n$/, "");
  console.log(urls_text);
  var blob = new Blob([urls_text], { type: "text/plain;charset=utf-8" });
  const a = document.createElement('a');
  a.href= URL.createObjectURL(blob);
  var fname = document.getElementById("summary").innerText.replace(/.* from /,"").replace(/ /g,"_") + '_image_urls.txt'
  a.download = fname;
  a.click();
	URL.revokeObjectURL(a.href);
}



function setBusyIndicator(busy) {
  if(busy) {
    console.log("busy");
    spinner.style.display = "inline-block";
  } else {
    console.log("done being busy");
    spinner.style.display = "none";  
  }
}


</script>

</body>
</html>