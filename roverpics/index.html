<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Rover Pics</title>
 
<style>

body {
  background-color: #555;
  color: #eeeeee
}

div {
  //border-style: solid;
  //border-color: yellow;
  //margin: 1px;
}

button {
  width: 18ch;
  font-weight: bold;
}

.checkbox_div {
  white-space: nowrap;
  text-align: left
}

table, td, th {
  color: #0b0b0b;
  border: 1px solid #999;
}

td {
  background-color: #eae6e0
}

th {
  vertical-align: text-top;
  background-color: #dcb
}

table {
  width: 100%;
  border-collapse: collapse;
}

h3 {
  text-decoration: underline;
}

#loading {
  float: none;
  display: none;
  width: 30px;
  height: 30px;
  margin-left: 20px;
  border: 8px solid rgba(255,255,255,.2);
  border-radius: 50%;
  border-top-color: #ccbbaa;
  animation: spin 1s ease-in-out infinite;
  -webkit-animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}
@-webkit-keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}


.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 0px 20px 0px 20px;
  border: 1px solid #888;
  width: 80%;
  color: #321;
}

.modal_close_button {
  color: #666;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

strong {
  font-weight: bold;
  text-decoration: underline;
}

gray {
  color: #A96;
}

.collapse {
  width: fit-content;
  display: inline-block;
  padding-left: 2px;
  padding-right: 2px;
}

</style>
</head>


<body onload="pageSetup()">

<!-- INFO -->
<div id="info_modal" class="modal">
  <div class="modal-content">
    <div style="display: inline-block">
      <h1>Rover Pics</h1>
      <p> R. Kinnett, 2021. </p>
    </div>
    <div style="float: right">
      <span id="modal_close_button" class="modal_close_button" onclick='closeModal()'>&times;</span>
    </div>
    <hr/>
    <p>   
      Also see NASA's raw images pages for <a href="https://mars.nasa.gov/msl/multimedia/raw-images/">MSL</a> (Curiosity) and <a href="https://mars.nasa.gov/mars2020/multimedia/raw-images/">Mars 2020</a> (Perseverance).
      <br/><br/>
    
      This interface retrieves image information lists via <a href="https://mars.nasa.gov/rss/">JPL's RSS API</a> and builds a table showing thumbnails and basic metadata for each image, along with links to the maximum available resolution images.  <span style="color: orange">Note:</span> JPL's RSS API (and this page, consequentially) returns incomplete results from MSL.
      <br/>

      <ol>
        <li> Start by selecting either MSL or M2020 in the upper left. Then, either:
          <ul>
            <li>click "Latest 25 images" to retrieve the latest <i>downlinked</i> images,</li>
            <li>or click "Current Sol" to retrieve images (if available) for the current sol,</li>
            <li>or enter a specific sol number and click Go, or click Prev/Next to increment/decrement sol number and retrieve images, if available.</li>
          </ul> 
        </li>
        <li> After retrieving image information and thumbnails, the user may:
          <ul>
            <li>
              Export a JSON file containing all info retrieved from JPL,
            </li>
            <li>
              Use checkboxes under the Camera and Type headings to narrow the table to specific images of interest, then use a browser extension to download all full-frame (or largest available) images remaining in the table via the provided links. 
              <ul>
                <li>
                  Try <a href="https://www.downthemall.net/">DownThemAll!</a> for Chrome, Firefox or Opera
                </li>
              </ul>
            </li>
            <li>
              Down-select further via checkboxes in the Select column and click "Export selected image URLs" to save a text file containing URLs to the full-frame (or max available) images which can be used in conjunction with command-line tools such as wget and curl.
            </li>
          </ul>
        </li>
      </ol>

      Also try URL parameters!  Examples:
      <br/>&nbsp;&nbsp;<a href="##PAGE_ADDR##?msl">##PAGE_ADDR##?msl</a>
      <br/>&nbsp;&nbsp;<a href="##PAGE_ADDR##?mars2020">##PAGE_ADDR##?mars2020</a>
      <br/>&nbsp;&nbsp;<a href="##PAGE_ADDR##?msl&sol3000">##PAGE_ADDR##?msl&sol3000</a>
      <br/>&nbsp;&nbsp;<a href="##PAGE_ADDR##?msl&sol3000&camera=HAZ">##PAGE_ADDR##?msl&sol3000&camera=haz</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<gray>(fetches hazcam images)</gray>
      <br/>&nbsp;&nbsp;<a href="##PAGE_ADDR##?msl&sol3052&filter=rhaz00311">##PAGE_ADDR##?msl&sol3052&filter=rhaz00311</a>&nbsp;&nbsp;&nbsp;<gray>(fetch images from specific sequence)</gray>
      <br/>&nbsp;&nbsp;<a href="##PAGE_ADDR##?mars2020&sol0&filter=EDL">##PAGE_ADDR##?mars2020&sol0&filter=EDL</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<gray>(fetches specific image type)</gray>
      <br/>&nbsp;&nbsp;<a href="##PAGE_ADDR##?mars2020&sol0&filter=EDL">##PAGE_ADDR##?mars2020&sol0&filter=ECV</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<gray>(fetches movie frames)</gray>
      <br/>&nbsp;&nbsp;<a href="##PAGE_ADDR##?mars2020&sol18&fullframe">##PAGE_ADDR##?mars2020&sol18&fullframe</a>
      
      <hr/>
      Image credits are provided in the JSON file which can be exported via the Export Metadata button.<br/><br/>
      
      Get the source code on <a href="https://github.com/rkinnett/rkinnett.github.io/tree/master/roverpics">github</a>.<br/>
      
      <b>Comments and suggestions: </b> <a href="https://twitter.com/rover_18">twitter</a> or <a href="https://discord.gg/Eky6AhRSnj">discord</a>
      
    </p>
  </div>
</div>



<!-- TOP ROW -->
<div style="display:block">

  <!-- TOP LEFT AREA -->
  <div style="overflow: hidden; display: inline-block">
    <div style="display: inline-block">
      <div style="display: block; margin: 6px 0px"">
        Mission:&nbsp;&nbsp;
        <select name="selectMission" id="selectMission" onchange='setMission(selectMission.value)'>
          <option value="mars2020" selected>Mars 2020</option>
          <option value="msl">MSL</option>
        </select>
      </div>
      
      <div style="display:block; margin: 8px 0px">
        Mission time:&nbsp;&nbsp;<span id="mission_clock"></span>
      </div>
      
      
      <div style="display: block; margin: 6px 0px"">
        <button class="collapse" onclick="getLatest()">Latest 25 images</button> 
        <button class="collapse" onclick="getCurrentSol()">Current Sol</button>
      </div>
      <div style="display: block; margin: 6px 0px"">
        <div style="display: inline-block">
          <label for="textSol">Sol:</label>
          <input  type="text" id="textSol" name="textSol" style="width: 6ex; margin-right: 0px" value="SOL">
          <button class="collapse" onclick="getSol(textSol.value);" style="margin-left: -6px">Go</button>
        </div>
        <div style="display: inline-block; margin: 0px 10px">
          <button class="collapse" onclick="prevSol()">Prev</button>
          <button class="collapse" onclick="nextSol()">Next</button>
        </div>
      </div>
    </div>
    <div style="display:inline-block; float: right">
      <div id="loading" style="display: none"></div>
    </div>
  </div>


  <!-- TOP RIGHT AREA -->
  <div style="float:right">
    <div style="display: block; padding: 5px">
      <button onclick='openModal()'>INFO</button>
    </div>
    <div style="display: block; padding: 5px">
      <button onclick="exportJson()">Export Metadata</button> 
    </div>
    <div style="display: block; padding: 5px">
      <button onclick="exportImageURLs()">Export selected image URLs</button> 
    </div>
  </div>

</div>

<div style="display:block; margin: 8px 0px">
  <span id="summary">Empty</span>
</div>

<table id="images_table">
<thead>
<tr>
  <th> <h3 title="This is currently only used for exporting URLs to file">Select</h3> 
    <div>
      <a onclick='selectImages("all")'>[all]</a>&nbsp;
      <a onclick='selectImages("none")'>[none]</a>
    </div>
    <div>
      <div class="checkbox_div">
        <input type="checkbox" id="checkboxShowSelected" name="checkboxShowSelected" onchange="doFilter()" checked>
        <label for="checkboxShowSelected">selected</label>
      </div>
      <div class="checkbox_div">
        <input type="checkbox" id="checkboxShowUnselected" name="checkboxShowUnselected" onchange="doFilter()" checked>
        <label for="checkboxShowUnselected">unselected</label>
      </div>
    </div>
  </th>
  <th> <h3>Thumbnail</h3> </th>
  <th> <h3 onclick="sortTable(1)">Camera</h3> 
    <div>
      <a onclick='selectCams("all")'>[all]</a>&nbsp;
      <a onclick='selectCams("none")'>[none]</a>
    </div>  
    <form id="cam_filter"></form>
  </th>
  <th> <h3 onclick="sortTable(2)">Frame Type</h3>  <form id="type_filter"></form> </th>
  <th> 
    <h3 onclick="sortTable(3)">Image ID</h3> 
    <input type="text" id="imageIdFilterPattern" name="imageIdFilterPattern" value="Keyword" onclick='setImageIdFilter("")' style="color:lightgray ">
    <input type="button" value="Filter" onclick="imageIdFilter()">
    <input type="button" value="Clear" onclick="clearImageIdFilter()">
  </th>
  <th> <h3 onclick="sortTable(4)">Date Taken</h3> </th>
</tr>
</thead>
<tbody id="table_body">
</tbody>
</table>





<script>

var got_images = false;
var table = document.getElementById("images_table");
var spinner = document.getElementById("loading");
var cameras = [];
var camera_type_img_counts = [];
var image_types = [];
var image_type_img_counts = [];
var num_rows = 0;
var num_images = 0;
var image_list_json, image_list;
var checked_checkbox_names = [];
var imageNameFilter = "";
var mission = "mars2020";
var urlParams = {
  mission:  "",
  sol:      "",
  camera:   "",
  filter:   "",
  frame:    "",
  latest:   false,
};
var missionFullName = {
  msl: "MSL",
  mars2020: "Mars 2020",
};

const earthDaysPerMarsDay = 1.02749125;


// Get the modal
var modal = document.getElementById("info_modal");

function openModal(){
  modal.style.display = "block";
}

function closeModal(){
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

// Handle enter key inside filter text box:
document.getElementById("imageIdFilterPattern").addEventListener("keyup", event => {
  if(event.key == "Enter") {
    imageIdFilter();
    event.preventDefault();
  }
});

// Handle enter key inside Sol text box:
document.getElementById("textSol").addEventListener("keyup", event => {
  if(event.key == "Enter") {
    sol = document.getElementById("textSol").value;
    urlParams.sol = sol;
    getSol(sol);
    event.preventDefault();
  }
});



////////// FUNCTION DEFINITIONS ///////////////

function pageSetup(){
  // Replace page address placeholder in Info modal:
  let page_address = window.location.origin + window.location.pathname;
  var modal = document.getElementById("info_modal");
  modal.innerHTML = modal.innerHTML.replaceAll("##PAGE_ADDR##",page_address);

  lmst = currentMarsTime();
  document.getElementById("textSol").value = lmst.sol;

  parseUrl();
  setMissionClock();
}


function parseUrl(){
  let paramString = window.location.search.toLowerCase().split('?')[1]; 
  if(!paramString) return;

  console.log("parsing URL arguments...");
  let queryString = new URLSearchParams(paramString); 

  for (let pair of queryString.entries()) { 
    key = pair[0];
    val = pair[1];
    console.log(key + (val.length>0? (": " + val) : "") );
    if(key=="m" || key=="mission"){
      console.log("MISSION");
      if(val=="msl" || val=="curiosity"){
        urlParams.mission = "msl";
        setMission("msl");
      } else if(val=="mars2020" || val=="m2020" || val=="perseverance"){
        urlParams.mission = "mars2020"
        setMission("mars2020");
      } else {
        console.log("unrecognized mission name:  " + val);
        return;
      }
    } else if(key=="msl" || key=="curiosity"){
      urlParams.mission = "msl";
      setMission("msl");
    } else if(key=="mars2020" || key=="m2020" || key=="perseverance"){
      urlParams.mission = "mars2020";
      setMission("mars2020");
    } else if(key=="latest"){
      console.log("LATEST");
      urlParams.sol = "latest";
    } else if(key=="s" || key=="sol") {
      console.log("SOL");
      if((/^[0-9]+$/).test(val)){
        urlParams.sol = val;
      } else {
        console.log("invalid sol string: " + val);
        return;
      }
    } else if((/^sol[0-9]+$/).test(key)) {
      console.log("SOL#");
      urlParams.sol = key.replace("sol","");
    } else if(key=="f" || key=="filt" || key=="filter") {
      if( (/^[a-z0-9_]+$/).test(val) ){
        val = val.toUpperCase();
        console.log("Filter: " + val);
        imageNameFilter = val;
        setImageIdFilter(val);
        urlParams.filter = val;
      } else {
        console.log("warning: invalid filter pattern specified in url parameters: " + val);
      }
    } else if(key=="c" || key=="cam" || key=="camera") {
      if( val && (/^[a-z0-9_]+$/).test(val) ){
        val = val.toUpperCase();
        console.log("Camera: " + val);
        urlParams.camera = val;
      } else {
        console.log('invalid camera descriptor "' + val + '"'); 
      }      
    } else if(key=="full" || key=="fullframe") {
      urlParams.frame = "full";
    } else if(key=="sub" || key=="subframe") {
      urlParams.frame = "subframe";
    } else if(key=="thumb" || key=="thumbnail") {
      urlParams.frame = "thumbnail";
    } else {
      console.log("unrecognized url parameter: " + key);
    }
  }

  if(urlParams.mission=="msl" || urlParams.mission=="mars2020"){
    if(urlParams.sol=="latest" /*|| urlParams.sol==""*/){
      getLatest();
    } else if( (/^[0-9]+$/).test(urlParams.sol)){
      document.getElementById("textSol").value = urlParams.sol;
      getSol(urlParams.sol);
    } else {
      console.log("URL params specified mission but not sol");
      getLatest();
    }
  }
}


function setMission(missionName){
  mission = missionName;
  urlParams.mission = mission;
  setThisPageUrlParams();
  setMissionClock();
  document.getElementById("selectMission").value = mission;
  
  var textSolTextBox = document.getElementById("textSol");
  //if(textSolTextBox.value=="SOL"){
    var lmst = currentMarsTime();
    textSolTextBox.value = lmst.sol;
  //}
}


function setImageIdFilter(toString){
  var keywordFilterTextbox = document.getElementById("imageIdFilterPattern");
  keywordFilterTextbox.value = toString;
  keywordFilterTextbox.style.color = "black";
}

function clearImageIdFilter(){
  var keywordFilterTextbox = document.getElementById("imageIdFilterPattern");  
  keywordFilterTextbox.value="Keyword";
  keywordFilterTextbox.style.color = "lightgray";
  imageNameFilter = "";
  doFilter();
}

function imageIdFilter(){
  var keywordFilterTextbox = document.getElementById("imageIdFilterPattern");
  if(keywordFilterTextbox.value!=="Keyword") {
    imageNameFilter = keywordFilterTextbox.value.toUpperCase();
    console.log("Filter: " + imageNameFilter);
    doFilter();
  }
}


function selectCams(allOrNone){
  console.log("selecting " + allOrNone + " cameras");
  var include = (allOrNone=="all")? true : false;  
  var camCheckboxes = table.tHead.rows[0].cells[2].querySelectorAll('input[type="checkbox"]');
  console.log(camCheckboxes);
  console.log(camCheckboxes.length);
  for(var i=0; i<camCheckboxes.length; i++){
    console.log(camCheckboxes[i]);
    camCheckboxes[i].checked = include;
  }
  doFilter();
}



function selectImages(allOrNone){
  console.log("selecting " + allOrNone + " images");
  var include = (allOrNone=="all")? true : false;
  for(var r=0; r<num_rows; r++){
    table.tBodies[0].rows[r].cells[0].querySelector('input[type="checkbox"]').checked = include;
  }
}


function getLatest(){
  setThisPageUrlParams(mission);
  imageQuery(mission);
  urlParams.sol = "";
  urlParams.mission = mission;
  setThisPageUrlParams();
}

function getCurrentSol(){
  lmst = currentMarsTime();
  document.getElementById("textSol").value = lmst.sol;
  getSol(lmst.sol);
}

function nextSol(){
  sol = document.getElementById("textSol").value*1;
  lmst = currentMarsTime();
  if((/^[0-9]+$/).test(sol) && sol<lmst.sol){
    sol+=1
    document.getElementById("textSol").value = sol;
    getSol(sol);
  }
}

function prevSol(){
  sol = document.getElementById("textSol").value*1;
  if((/^[0-9]+$/).test(sol) && sol>0){
    sol-=1;
    document.getElementById("textSol").value = sol;
    getSol(sol);
  }
}


function getSol(sol){
  if ( /^[0-9]+$/.test(sol)) {
    document.getElementById("textSol").value = sol;
    imageQuery(mission, sol);
    urlParams.sol = sol;
    urlParams.mission = mission;
    setThisPageUrlParams();
  } else {
    console.log("not a number: " + sol);
  }
}


function setThisPageUrlParams(){
  var paramsCount = 0;
  var paramString = "";
  if(urlParams.mission!==""){
    paramString += urlParams.mission;
    paramsCount++;
  }
  if(urlParams.sol!==""){
    if(paramsCount>0) paramString += "&";
    paramString += "sol" + urlParams.sol;
    paramsCount++;
  }
  if(urlParams.camera!==""){
    if(paramsCount>0) paramString += "&";
    paramString += "camera=" + urlParams.camera;
    paramsCount++;
  }
  if(urlParams.frame!==""){
    if(paramsCount>0) paramString += "&";
    paramString += urlParams.frame;
    paramsCount++;
  }
  if(urlParams.filter!==""){
    if(paramsCount>0) paramString += "&";
    paramString += "filter=" + urlParams.filter;
    paramsCount++;
  }

  console.log(urlParams);
  console.log(paramsCount + " url params");
  console.log("URL param string: " + paramString);

  if(paramsCount>0){
    this_page_url_base = location.protocol + '//' + location.host + location.pathname;
    newUrl = this_page_url_base + "?" + paramString
    console.log("Setting url to:  " + newUrl);
    window.history.pushState({}, null, newUrl);
  }
}


  
function imageQuery(mission, sol){
  const base_url = 'https://mars.nasa.gov/rss/api/?feed=raw_images&feedtype=json&category=' + mission;
  const images_per_page = 100; // 100 is API max

  clearTable();

  // If sol was not specified, just do basic full-frame latest image query:
  if(sol === undefined){
    console.log("sol undefined.. performing standard query only");
    getFullframeStillframes(base_url, function(){
      tabulateImages();
      buildTable();
    });
    return;
  }
  
  
  // Get full-frame still frames:
  var rss_url = base_url + '&condition_2=' + sol + ':sol:gte&condition_3=' + sol + ':sol:lte&num=' + images_per_page;
  console.log("Getting full-frame still frames");
  getFullframeStillframes(rss_url + '&extended=sample_type::full', function(){
  
    // Get thumbnail still frames:
    console.log("Getting thumbnail still frames");
    getPaginatedFrames(rss_url + '&extended=sample_type::thumbnail', function(){
    
      // Get full-frame movie frames:
      console.log("Getting full-frame movie frames");
      getPaginatedFrames(rss_url + '&extended=sample_type::full,product_id::ecv,', function(){

        // Get thumbnail movie frames:
        console.log("Getting subframe movie frames");
        getPaginatedFrames(rss_url + '&extended=sample_type::thumbnail,product_id::ecv,', function(){

          tabulateImages();
          buildTable();
          return;
        });
      });
    });
  });
}


function getPaginatedFrames(url, callback){
  const initial_image_count = image_list_json.images.length;
  
  // Extended query to see if there are any video frames from this sol:    
  fetchJson(url + '&page=' + 0, function(extd_image_list_json){
    console.log(extd_image_list_json);

    // If first extended query indicates images are available, then get total count and calculate page count:
    var num_pages = 0;
    if(extd_image_list_json && extd_image_list_json.total_results){
      const num_pages = Math.ceil(extd_image_list_json.total_results / extd_image_list_json.per_page);
    }      
    console.log("extended query indicates " + extd_image_list_json.total_results + " images available");

    // Append images from the first page, one at a time, to master list
    if(extd_image_list_json.images && extd_image_list_json.images.length>0 ){
      var this_page_img_count = 0;
      extd_image_list_json.images.forEach(function(img){
        image_list_json.images[initial_image_count + extd_image_list_json.page*extd_image_list_json.per_page + this_page_img_count] = img;
        this_page_img_count++;
      });
    }
    
    // If there are no frames, or just one page, then proceed to tabulation
    if(num_pages<=1){
      callback();
      return;
    }

    // If there are more pages then loop through them:        
    var pages_loaded = 1;
    for(var page=1; page<num_pages; page++){
      fetchJson(rss_url + '&condition_2=' + sol + ':sol:gte&condition_3=' + sol + ':sol:lte&num=' + extd_image_list_json.per_page + '&page=' + page + '&extended=product_id::ecv', function(extd_image_list_json){
        console.log(extd_image_list_json);

        // Append images, one at a time, to master list
        if(extd_image_list_json.images && extd_image_list_json.images.length>0 ){
          console.log("appending page " + extd_image_list_json.page + " images to image list");
          var this_page_img_count = 0;
          extd_image_list_json.images.forEach(function(img){
            image_list_json.images[initial_image_count + extd_image_list_json.page*extd_image_list_json.per_page + this_page_img_count] = img;
            this_page_img_count++;
          });
        }
        
        pages_loaded++;
        if(pages_loaded>=num_pages){
          console.log("finished query");
          console.log("extended query returned " + extd_image_list_json.total_results + ' images spanning ' + num_pages + ' pages');
          callback();
        }            
      });
    }
  });
}



function getFullframeStillframes(rss_url, callback){
  fetchJson(rss_url, function(rxJson){
    image_list_json = rxJson;
    console.log(image_list_json);
    if(!image_list_json || !image_list_json.images || !image_list_json.images.length) return;    
    got_images = true;
    if(callback) callback();
  });
}



function fetchJson(url, callback){
  console.log("fetching rss feed:  " + url);
  setBusyIndicator(true);
  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4) {
      if (this.status == 200) {
        console.log(this.responseText);
        if(callback) callback(JSON.parse(this.responseText));
      } else {
        console.log("unexpected response:");
        console.log(JSON.stringify(this.responseText));
        alert("Error fetching requested feed. The server may be overloaded, or it's possible no images have been posted from the requested sol.");
      }
      setBusyIndicator(false);
    }
  };
  setBusyIndicator(true);
  xhttp.open("GET", url, true);
  setTimeout(function(){ xhttp.send(null); }, 100);
}



function clearTable(){
  // do this in reverse otherwise takes a lot of resources to rebuild bottom of table as top rows are deleted!
  for (var r=table.tBodies[0].rows.length; r>0; r--) {
    table.deleteRow(r);
  }
  num_rows = 0;
}


function tabulateImages(){
  console.log("tabulating images");
  cameras = [];
  image_types = [];
  camera_type_img_counts = [];
  image_type_img_counts = [];
  
  image_list = image_list_json.images;
  num_images = image_list.length;
  start_sol = image_list[0].sol; // initial value; will check each image
  end_sol = image_list[0].sol; // initial value; will check each image

  for(n=0; n<num_images; n++){
    image_list[n].selected = false;
    var this_img = image_list[n];
    var type     = this_img.sample_type;
    var camera   = this_img.camera.instrument;
    // console.log('image ' + n + ', ' + camera + ', ' + type);

    if(!cameras.includes(camera)) {
      cameras.push(camera);
      camera_type_img_counts[camera]=0;
    }
    if(!image_types.includes(type)) {
      image_types.push(type);
      image_type_img_counts[type]=0;
    }
    camera_type_img_counts[camera]++;
    image_type_img_counts[type]++;
    
    // Get sol range:
    if(image_list[n].sol<start_sol) {
      start_sol = image_list[n].sol;
    }
    if(image_list[n].sol<end_sol) {
      end_sol = image_list[n].sol;
    }
    
  }

  // Update summary:
  document.getElementById("summary").innerText = 'Query returned ' + image_list.length + ' images from ' + missionFullName[image_list_json.mission] + ' sol ' + start_sol + ((end_sol>start_sol)?(' to sol ' + end_sol):'');

  if( image_list.length==25 && start_sol*1<document.getElementById("textSol").value*1 ){
    console.log("Query returned latest 25");
    document.getElementById("summary").innerText += " (images may not be available for requested sol)";
  }

  console.log([start_sol, end_sol]);

  console.log(camera_type_img_counts);
  console.log(image_type_img_counts);
  
  // Clear and repopulate filter checkboxes:
  document.getElementById("cam_filter").innerHTML = "";
  document.getElementById("type_filter").innerHTML = "";
  cameras.forEach(function(cam_type){
    var checked = (urlParams.camera=="" || new RegExp(urlParams.camera).test(cam_type) );
    makeCheckbox("cam_filter", cam_type, checked);
  });
  image_types.forEach(function(img_type){
    var checked = (urlParams.frame=="" || new RegExp(urlParams.frame).test(img_type.toLowerCase()) );
    makeCheckbox("type_filter",img_type, checked);
  });
  setBusyIndicator(false);
}



function buildTable(){
  console.log("building table");
  clearTable();

  var lmst = currentMarsTime();

  // rebuild checked-checkboxes list:
  checked_checkbox_names = [];
  var checked_checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
  console.log(checked_checkboxes);

  for (var i=0; i<checked_checkboxes.length; i++) {
    checked_checkbox_names.push(checked_checkboxes[i].name);
  }
  console.log(checked_checkbox_names);
  
  var showSelected = checked_checkbox_names.includes("checkboxShowSelected");
  var showUnselected = checked_checkbox_names.includes("checkboxShowUnselected");
  //console.log([showSelected, showUnselected]);

  console.log('Filter pattern: "' + imageNameFilter + '"');
  var image_id_filter = new RegExp(imageNameFilter);

  // build table:
  for(n=0; n<num_images; n++){
    var this_img  = image_list[n];
    var img_type  = this_img.sample_type;
    var cam_type  = this_img.camera.instrument;
    var image_id  = this_img.imageid
    var selected  = this_img.selected;
    var hours_ago;
    
    if( checked_checkbox_names.includes(cam_type) && 
        checked_checkbox_names.includes(img_type) && 
        image_id_filter.test(image_id) &&
        ((selected && showSelected) || (!selected && showUnselected))
      ){
      //console.log("showing image " + n + " " + cam_type + " " + img_type);

      thumb_url   = this_img.image_files["small"];
      biggest_url = this_img.image_files["full_res"];
      date_lmst   = this_img.date_taken_mars.replace("M"," ").replace(/-0*/," ").replace(/\.[0-9]+$/,"");
      date_utc    = this_img.date_taken_utc.replace("T"," ");    
      date_local  = new Date(date_utc + " UTC").toString();
      hours_ago   = (new Date() - new Date(date_utc + " UTC"))/1000/60/60;

      hours_ago_lmst = hoursSinceLmst(date_lmst);
      hours_ago = (hours_ago_lmst && (!hours_ago || hours_ago_lmst>hours_ago)) ? hours_ago_lmst : hours_ago;

      var row = table.tBodies[0].insertRow(num_rows++);
      var cell0 = row.insertCell(0);
      var cell1 = row.insertCell(1);
      var cell2 = row.insertCell(2);
      var cell3 = row.insertCell(3);
      var cell4 = row.insertCell(4);
      var cell5 = row.insertCell(5);

      row.img_idx = n;

      cell0.innerHTML = '<input type="checkbox" class="selection_checkbox" id="SEL_' + image_id + '" ' + (selected?"checked":"") + '>';
      cell1.innerHTML = '<img src=' + thumb_url + ' />';
      cell2.innerHTML = cam_type;
      cell3.innerHTML = '<a href=' + biggest_url + ' download>' + img_type + '</a>';
      cell4.innerHTML = image_id;
      cell5.innerHTML = date_lmst.replace(/ /,"&nbsp;") + ' <br/> ' + date_utc + ' <br/> ' + date_local + ' ' + (hours_ago ? "<br/><br/>("+hours_ago.toPrecision(2)+" hours ago)" : "");

    } else {
      //console.log("skipping image " + n + " " + cam_type + " " + img_type);
    }    
  }
  setBusyIndicator(false);
}



function makeCheckbox(container_name, checkbox_name, checked){
  checked = (checked==undefined)? true : checked;
  var count = (container_name=="cam_filter") ? camera_type_img_counts[checkbox_name] : image_type_img_counts[checkbox_name];
  var container = document.getElementById(container_name);
  container.innerHTML += '<div class="checkbox_div"><input type="checkbox" name="' + checkbox_name + '" id="' + checkbox_name + '" onchange="doFilter()" ' + (checked?'checked':'') + '><label for="' + checkbox_name + '">' + checkbox_name + '&nbsp;(' + count + ')</label></div>';
}


function doFilter() {
  console.log("filtering");
  setBusyIndicator(true);
  
  // Note selection within images structure:
  for(var row of table.tBodies[0].rows){
    var checked = row.cells[0].getElementsByClassName("selection_checkbox")[0].checked;
    image_list[row.img_idx].selected = checked; 
  }
  
  setTimeout(function(){buildTable()}, 200);
}


function sortTable(n){
  setBusyIndicator(true);
  setTimeout(function(){ doSort(n) }, 200);
}



function setMissionClock(){
  var lmst = currentMarsTime();
  document.getElementById("mission_clock").innerText = "Sol " + lmst.sol + ", " + lmst.hour + ":" + lmst.min.toString().padStart(2,"0");
}


function currentMarsTime(){
  if(mission=="msl"){
    var msd_landing = 49268;
    var lat_degW = 222.6;  
  } else if(mission=="mars2020") {
    var msd_landing = 52303;
    var lat_degW = 282.5;
  } else return {};
  
  var now_msec_since_1970 = new Date().getTime();
  var jd_ut = 2440587.5 + now_msec_since_1970/1e3/86400;
  var jd_tt = jd_ut + (35+32.184)/86400;
  var j2000 = jd_tt - 2451545;
  var msd   = (j2000-4.5)/1.027491252 + 44796 -0.00096;

  var lmst = {};
  var solf  = msd - msd_landing - lat_degW/360;
  lmst.sol   = Math.floor(solf);
  var hourf = (solf % 1) * 24;
  lmst.hour  = Math.floor(hourf);
  var minf  = (hourf % 1)*60;
  lmst.min   = Math.floor(minf);
  //console.log(lmst);
  return lmst;
}


function hoursSinceLmst(lmstStr){
  // if lmst is correctly formatted string then split into parts:
  const lmstRegex = /([Ss][Oo][Ll][ -]?0*)?([0-9]+)[M ]0*([0-9]+):([0-9]+)(:([0-9]+)(\.([0-9]+))?)?$/;
  if( lmstRegex.test(lmstStr) ){
    var fromLmst = lmstStr.replace(lmstRegex,"$2 $3 $4 $6 $7").split(" ");
    //console.log(fromLmst);
    fromLmstSolFrac = fromLmst[0]*1 + fromLmst[1]/24 + fromLmst[2]/24/60;
    
    var nowLmst = currentMarsTime();
    var nowLmstSolFrac = nowLmst.sol + nowLmst.hour/24 + nowLmst.min/24/60;
    
    var solDiff = nowLmstSolFrac - fromLmstSolFrac;
    if(solDiff<(nowLmst.sol+1) && solDiff>0){
      return solDiff * earthDaysPerMarsDay * 24;
    } else {
      console.log("sol diff");
      console.log([fromLmstSolFrac, nowLmstSolFrac, solDiff]);
    }
  } else {
    console.log('unrecognized lmst string format: "' + lmstStr + '"');
  }
  return;
}



function doSort(n) {
  console.log("starting sort");
  var rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  switching = true;
  // Set the sorting direction to ascending:
  dir = "asc";
  // loop continues until no switching has been done:
  while (switching) {
    switching = false;
    rows = table.tBodies[0].rows;
    // Loop through all table rows (except the first, which contains table headers):
    for(var i=0; i<rows.length-1; i++) {
      shouldSwitch = false;
      /* Get the two elements you want to compare, one from current row and one from the next: */
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i+1].getElementsByTagName("TD")[n];
      /* Check if the two rows should switch place, based on the direction, asc or desc: */
      if (dir == "asc") {
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      } else if (dir == "desc") {
        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      }
    }
    if (shouldSwitch) {
      /* If a switch has been marked, make the switch and mark that a switch has been done: */
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      // Each time a switch is done, increase this count by 1:
      switchcount ++;
    } else {
      /* If no switching has been done AND the direction is "asc",
      set the direction to "desc" and run the while loop again. */
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
  console.log("done sorting");
  setBusyIndicator(false);
}


function exportImageURLs(){
  if(!got_images) {
    alert('Use the mission "Latest" or "Sol" buttons to retrieve image information first');
    return;
  }
  var urls_text = '';
  for(var r=0; r<num_rows; r++){
    var checked = table.tBodies[0].rows[r].cells[0].querySelector('input[type="checkbox"]').checked;
    if(checked){
      urls_text += table.tBodies[0].rows[r].cells[3].querySelector('a').href + '\n';
    }
  }
  urls_text = urls_text.replace(/\n$/, "");
  console.log(urls_text);
  var blob = new Blob([urls_text], { type: "text/plain;charset=utf-8" });
  const a = document.createElement('a');
  a.href= URL.createObjectURL(blob);
  var fname = document.getElementById("summary").innerText.replace(/.* from /,"").replace(/ /g,"_") + '_image_urls.txt'
  a.download = fname;
  a.click();
	URL.revokeObjectURL(a.href);
}

function exportJson(){
  if(!got_images) {
    alert('Use the mission "Latest" or "Sol" buttons to retrieve image information first');
    return;
  }
  var blob = new Blob([JSON.stringify(image_list_json, null, '\t')], { type: "text/plain;charset=utf-8" });
  const a = document.createElement('a');
  a.href= URL.createObjectURL(blob);
  var fname = document.getElementById("summary").innerText.replace(/.* from /,"").replace(/ /g,"_") + '_image_data.json'
  a.download = fname;
  a.click();
	URL.revokeObjectURL(a.href);
}




function setBusyIndicator(busy) {
  if(busy) {
    console.log("busy");
    spinner.style.display = "inline-block";
  } else {
    console.log("done being busy");
    spinner.style.display = "none";  
  }
}


</script>

</body>
</html>