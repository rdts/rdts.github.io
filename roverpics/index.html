<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Rover Pics</title>

<style>

button {
  width: 18ch
}

.checkbox_div {
  white-space: nowrap;
  text-align: left
}

table, td, th {
  border: 1px solid black;
}

table {
  width: 100%;
  border-collapse: collapse;
}

#loading {
  float: right;
  display: none;
  width: 20px;
  height: 20px;
  border: 5px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #ccaaaa;
  animation: spin 1s ease-in-out infinite;
  -webkit-animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}
@-webkit-keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}

</style>
</head>


<body>

<div id="loading"></div>

<button onclick="getLatest('msl')" >MSL latest</button> 
<button onclick="getSol('msl')" >MSL sol</button>
</br>
</br>
<button onclick="getLatest('mars2020')" >Mars 2020 Latest</button>
<button onclick="getSol('mars2020')" >Mars 2020 Sol</button>
</br>

<br/>
<div id="content" >Empty</div>


<table id="images_table">
<tr>
  <th>Image</th>
  <th onclick="sortTable(1)">Camera <br/> <form id="cam_filter"></form>  </th>
  <th onclick="sortTable(2)">Type   <br/> <form id="type_filter"></form> </th>
  <th onclick="sortTable(3)">Image ID</th>
  <th onclick="sortTable(4)">Date Taken</th>
</tr>
</table>


<script>

var table = document.getElementById("images_table");
var spinner = document.getElementById("loading");
var cameras = [];
var camera_type_img_counts = [];
var image_types = [];
var image_type_img_counts = [];

function getLatest(mission){
  fetchRss('https://mars.nasa.gov/rss/api/?feed=raw_images&feedtype=json&category=' + mission);
}

function getSol(mission){
  var sol = parseInt(window.prompt("Specify sol", 0), 0);
  if ( /^[0-9.,]+$/.test(sol)) {
    fetchRss('https://mars.nasa.gov/rss/api/?feed=raw_images&feedtype=json&category=' + mission + '&sol=' + sol);
  } else {
    console.log("not a number, or canceled.");
  }
}


  
function fetchRss(rss_url){
  console.log("fetching rss feed:  " + rss_url);
  spinner.style.display = "block";
  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4) {
      spinner.style.display = "none";
      if (this.status == 200) {
        console.log(this.responseText);
        rss_json = JSON.parse(this.responseText);
        console.log(rss_json);
        renderJson(rss_json);
      } else {
        console.log("unexpected response:");
        console.log(this.responseText);
        clearTable();
        alert("Error fetching requested feed. It's possible no images have been posted from the requested sol.");
      }
    }
  };
  xhttp.open("GET", rss_url, true);
  xhttp.send();
}


function clearTable(){
  for (var r=table.rows.length-1; r>0; r--) {
    table.deleteRow(r);
  }
}



function renderJson(json){
  cameras = [];
  image_types = [];
  
  camera_type_img_counts = [];
  image_type_img_counts = [];
  
  var num_images = json.images.length;
  start_sol = json.images[0].sol;
  end_sol = json.images[num_images-1].sol;
  
  clearTable();
  
  document.getElementById("content").innerHTML = '<h3>' + json.images.length + ' images from ' + json.mission.toUpperCase() + ' sol ' + start_sol + ((end_sol>start_sol)?(' to sol ' + end_sol):'') + '</h3>';

  for(n=0; n<num_images; n++){
    var this_img = json.images[n];
  
    var row = table.insertRow(n+1);
    var cell0 = row.insertCell(0);
    var cell1 = row.insertCell(1);
    var cell2 = row.insertCell(2);
    var cell3 = row.insertCell(3);
    var cell4 = row.insertCell(4);

    thumb_url   = this_img.image_files["small"];
    biggest_url = this_img.image_files["full_res"];
    type        = this_img.sample_type;
    camera      = this_img.camera.instrument;
    image_id    = this_img.imageid;
    date_lmst   = this_img.date_taken_mars.replace("M"," ");
    date_utc    = this_img.date_taken_utc.replace("T"," ");    
    date_local  = new Date(date_utc + " UTC").toString();    

    cell0.innerHTML = '<a href=' + biggest_url + '><img src=' + thumb_url + '></img></a>';
    cell1.innerHTML = camera;
    cell2.innerHTML = type;
    cell3.innerHTML = image_id;
    cell4.innerHTML = date_lmst + ' <br/> ' + date_utc + ' <br/> ' + date_local;

    if(!cameras.includes(camera)) {
      cameras.push(camera);
      camera_type_img_counts[camera]=0;
    }
    if(!image_types.includes(type)) {
      image_types.push(type);
      image_type_img_counts[type]=0;
    }
    
    camera_type_img_counts[camera]++;
    image_type_img_counts[type]++;
  }
  
  console.log(camera_type_img_counts);
  console.log(image_type_img_counts);
  
  // Clear and repopulate filter checkboxes:
  document.getElementById("cam_filter").innerHTML = "";
  document.getElementById("type_filter").innerHTML = "";
  cameras.forEach(function(camera){makeCheckbox("cam_filter",camera)});
  image_types.forEach(function(type){makeCheckbox("type_filter",type)});
}



function makeCheckbox(container_name, checkbox_name){
  var count = (container_name=="cam_filter") ? camera_type_img_counts[checkbox_name] : image_type_img_counts[checkbox_name];
  var container = document.getElementById(container_name);
  container.innerHTML += '<div class="checkbox_div"><input type="checkbox" name="' + checkbox_name + '" id="' + checkbox_name + '" onchange="doFilter()" checked><label for="' + checkbox_name + '">' + checkbox_name + '&nbsp;(' + count + ')</label></div>';
}


function doFilter() {
  console.log("filtering");
  checked_checkbox_names = [];
  var checked_checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
  for (var i = 0; i < checked_checkboxes.length; i++) {
    checked_checkbox_names.push(checked_checkboxes[i].name);
  }
  console.log(checked_checkbox_names);
  for(r=1; r<table.rows.length; r++){
    cam_type = table.rows[r].cells[1].innerText;
    img_type = table.rows[r].cells[2].innerText;
    if(checked_checkbox_names.includes(cam_type) && checked_checkbox_names.includes(img_type)){
      table.rows[r].style.display = 'table-row';
      console.log("showing row " + r + " " + cam_type + " " + img_type);
    } else {
      table.rows[r].style.display = 'none';
      console.log("hiding row " + r + " " + cam_type + " " + img_type);
    }
  }
}



function sortTable(n) {
  var rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  switching = true;
  // Set the sorting direction to ascending:
  dir = "asc";
  // loop continues until no switching has been done:
  while (switching) {
    switching = false;
    rows = table.rows;
    // Loop through all table rows (except the first, which contains table headers):
    for (i = 1; i < (rows.length - 1); i++) {
      shouldSwitch = false;
      /* Get the two elements you want to compare, one from current row and one from the next: */
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      /* Check if the two rows should switch place, based on the direction, asc or desc: */
      if (dir == "asc") {
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      } else if (dir == "desc") {
        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      }
    }
    if (shouldSwitch) {
      /* If a switch has been marked, make the switch and mark that a switch has been done: */
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      // Each time a switch is done, increase this count by 1:
      switchcount ++;
    } else {
      /* If no switching has been done AND the direction is "asc",
      set the direction to "desc" and run the while loop again. */
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}



</script>


</body>
</html>